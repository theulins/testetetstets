CREATE DATABASE IF NOT EXISTS tcc3 CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
USE tcc3;
CREATE TABLE IF NOT EXISTS users ( id INT AUTO_INCREMENT PRIMARY KEY, name VARCHAR(120) NOT NULL, email VARCHAR(160) NOT NULL UNIQUE, password_hash VARCHAR(255) NOT NULL, role ENUM('viewer','editor','admin') NOT NULL DEFAULT 'viewer', theme_preference ENUM('system','light','dark') DEFAULT 'system', created_at DATETIME DEFAULT CURRENT_TIMESTAMP, updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP );
CREATE TABLE IF NOT EXISTS settings ( `key` VARCHAR(64) PRIMARY KEY, `value` TEXT );
CREATE TABLE IF NOT EXISTS companies ( id INT AUTO_INCREMENT PRIMARY KEY, fantasy_name VARCHAR(160), corporate_name VARCHAR(160), cnpj VARCHAR(18), ie VARCHAR(40), address VARCHAR(160), zip VARCHAR(12), city VARCHAR(100), state VARCHAR(2), phone VARCHAR(40), cel VARCHAR(40), whatsapp VARCHAR(40), email VARCHAR(160), instagram VARCHAR(160), business_activity VARCHAR(160), foundation_date VARCHAR(20), employees_qty INT, sector VARCHAR(100), accounting_firm VARCHAR(160), referral VARCHAR(160), notes TEXT, svc_spc BOOLEAN DEFAULT 0, svc_nfe BOOLEAN DEFAULT 0, svc_nfce BOOLEAN DEFAULT 0, svc_mdfe BOOLEAN DEFAULT 0, svc_cte BOOLEAN DEFAULT 0, svc_cfe BOOLEAN DEFAULT 0, services_obs TEXT, plan_type VARCHAR(40), plan_value VARCHAR(40), due_date VARCHAR(20), auth_site BOOLEAN DEFAULT 0, auth_whatsapp BOOLEAN DEFAULT 0, auth_email BOOLEAN DEFAULT 0, created_at DATETIME DEFAULT CURRENT_TIMESTAMP, updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP, UNIQUE KEY uniq_cnpj (cnpj) );
CREATE TABLE IF NOT EXISTS company_partners ( id INT AUTO_INCREMENT PRIMARY KEY, company_id INT NOT NULL, name VARCHAR(160), cpf VARCHAR(20), FOREIGN KEY (company_id) REFERENCES companies(id) ON DELETE CASCADE );
CREATE TABLE IF NOT EXISTS company_documents ( id BIGINT AUTO_INCREMENT PRIMARY KEY, company_id INT NOT NULL, version INT NOT NULL, pdf_path VARCHAR(255) NOT NULL, created_by INT, created_at DATETIME DEFAULT CURRENT_TIMESTAMP, UNIQUE KEY uniq_company_version (company_id, version), FOREIGN KEY (company_id) REFERENCES companies(id) ON DELETE CASCADE );
CREATE TABLE IF NOT EXISTS audit_logs ( id BIGINT AUTO_INCREMENT PRIMARY KEY, entity VARCHAR(40) NOT NULL, entity_id BIGINT NOT NULL, action ENUM('create','update','delete') NOT NULL, user_id INT NULL, created_at DATETIME DEFAULT CURRENT_TIMESTAMP, INDEX idx_entity (entity, entity_id) );
CREATE TABLE IF NOT EXISTS cnpj_cache ( cnpj VARCHAR(14) PRIMARY KEY, payload_json JSON, fetched_at DATETIME );
INSERT IGNORE INTO users (id,name,email,password_hash,role,theme_preference) VALUES (1,'Administrador','admin@tcc3.local','$2a$10$h946sEnzQ1fAt/jDrWE8pOpJy08FH3vIAFIVH0B.a52g3V.rTQo9q','admin','system');
